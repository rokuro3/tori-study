# 音声再生エラーの修正（2026-01-25）

## 問題
フロントエンドで「The element has no supported sources.」というエラーが表示され、音声が再生できない。

## 原因
1. FastAPIが返す音声URLが相対パス（`/audio/xxx.mp3`）
2. Next.jsはポート3000で動作しているため、ポート8000のFastAPIにアクセスできない
3. フロントエンドが音声URLを完全なURL（`http://localhost:8000/audio/xxx.mp3`）に変換していなかった

## 修正内容

### 1. フロントエンドAPI修正（`app/src/lib/quiz/api.ts`）
音声URLが相対パスの場合、完全なURLに自動変換する処理を追加：

```typescript
export async function fetchQuizQuestion(): Promise<ApiQuizQuestion> {
  const response = await fetch(`${API_BASE_URL}/api/quiz/question`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    },
  })

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: 'Unknown error' }))
    throw new Error(error.detail || `HTTP error: ${response.status}`)
  }

  const data = await response.json()
  
  // 音声URLが相対パスの場合、完全なURLに変換
  if (data.audio_url && data.audio_url.startsWith('/')) {
    data.audio_url = `${API_BASE_URL}${data.audio_url}`
  }
  
  return data
}
```

### 2. FastAPI StaticFiles修正（`api/main.py`）
StaticFilesのマウントを全てのAPIエンドポイントの後に移動：

```python
# 静的ファイル（音声ファイル）を配信
# 注意: StaticFilesは全てのAPIエンドポイントの後にマウントする
app.mount("/audio", StaticFiles(directory=str(SOUND_DIR)), name="audio")
```

## 修正後の動作確認

### 1. FastAPIの音声配信テスト
```bash
python3 -c "import requests; r = requests.get('http://localhost:8000/audio/スズメ　平塚博物館用.mp3'); print('Status:', r.status_code); print('Content-Type:', r.headers.get('content-type'))"
```

結果: ✅ Status: 200, Content-Type: audio/mpeg

### 2. クイズ問題の音声URL確認
```bash
python3 -c "import requests; r = requests.get('http://localhost:8000/api/quiz/question'); print('Audio URL:', r.json()['audio_url'])"
```

結果: `/audio/xxx.mp3` （相対パス）
→ フロントエンドで `http://localhost:8000/audio/xxx.mp3` に変換される

## 修正後の手順

### 1. Next.jsを再起動
```bash
# 現在実行中のNext.jsを停止（Ctrl+C）
# その後、再起動
cd /root/toriStudy/app
npm run dev
```

### 2. ブラウザでテスト
http://localhost:3000/quiz にアクセスして音声が再生されることを確認

## トラブルシューティング

### 音声が再生されない場合

#### 1. FastAPIが起動しているか確認
```bash
cd /root/toriStudy
./check-fastapi.sh
```

#### 2. 音声ファイルに直接アクセスできるか確認
ブラウザで以下にアクセス:
http://localhost:8000/audio/スズメ　平塚博物館用.mp3

#### 3. ブラウザの開発者ツールを確認
- F12キーで開発者ツールを開く
- Networkタブで音声ファイルのリクエストを確認
- Consoleタブでエラーメッセージを確認

#### 4. CORSエラーの場合
FastAPIのCORS設定は `allow_origins=["*"]` になっているので問題ないはずですが、
エラーが出る場合は設定を確認してください。

### よくあるエラー

| エラー | 原因 | 解決方法 |
|--------|------|----------|
| The element has no supported sources | 音声URLが不正 | Next.jsを再起動 |
| Network error | FastAPIが停止 | FastAPIを起動 |
| 404 Not Found | ファイルが存在しない | `python3 api/parse_sound_files.py` を実行 |
| CORS error | CORS設定の問題 | FastAPIのCORS設定を確認 |

## 技術的な詳細

### 音声URLの変換処理
1. FastAPI: `/audio/xxx.mp3` を返す
2. フロントエンドAPI: `http://localhost:8000/audio/xxx.mp3` に変換
3. React Component: 変換済みのURLを使用
4. ブラウザ: FastAPIから音声ファイルを取得

### CORS設定
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

これにより、Next.js（localhost:3000）からFastAPI（localhost:8000）へのアクセスが許可されます。

## 確認済み
- ✅ FastAPIサーバーが起動中
- ✅ 音声ファイルに直接アクセス可能
- ✅ CORS設定が正しい
- ✅ StaticFilesのマウント位置が正しい
- ✅ フロントエンドのURL変換処理が実装済み

## 次のステップ
Next.jsを再起動して、音声が正しく再生されることを確認してください。
